<!comment This is a hive panel developed using HivePlotter.>
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link type="text/css" rel="stylesheet" href="panel_style.css"/>
    </head>
    <body>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="http://d3js.org/d3.hive.v0.min.js"></script>
        <div id="container">
            <div id="title"></div>
            <div id="panel"></div>
            <div id="search"></div>
            <div id="reveal"></div>
            <div id="controlpanel">
                <form action="">
                    If a node's  <br>
                    <select id= "node_property" onchange="make_value_options()">
                        <option>property</option>
                    </select>
                    <select id= "equality">
                        <option>=</option>
                    </select>
                    <select id= "node_value">
                    </select>
                    <br>then color:   
                    <input type="text" id="node_colour" size="6" value="black"/>  
                    <input value ="Highlight" onclick="make_coloring_nodes();" type = "button"/><br>
                </form>
            </div>
        </div>
        <script src="friends_panel_test_nodes.js"></script>
        <script src="friends_panel_test_edges.js"></script>

        <script>

          // ****************************************** //
         //         USER DEFINED PARAMETERS            //
        // ****************************************** //

        var SVGTitle = 'Friends Forever' + ' Hive Panel'

        var colorNeutral = '#42264B'

        var num_axis = 3
            angle = [0.0001, 2.09, 4.19]

        var nodeColor = 'blue'
            edgeColor = ['blue']
            linkwidth = 1.3
            oplink = 0.8
            opnode = 0.8

        var nodesize = 5
            nodestroke = 0.4
            nodestrokecolor = "grey"

        var linkfill = "none"
            bkgcolor = "white"

        var hoverOverTime = 900


          // ****************************************** //
         //         WEB PAGE LAYOUT PARAMETERS         //
        // ****************************************** //



        var angles = d3.scale.ordinal()
            .domain(d3.range(num_axis))
            .range(angle);

        var link_color = d3.scale.linear()
            .domain(d3.range(0,edgeColor.length,1.0))
            .range(edgeColor);

        d3.select("body").select("#title")
            .append("h1").html('<center>'+SVGTitle+'</center>')
            .style("color", colorNeutral)


          // ****************************************** //
         //       ORGANIZING PANEL TABLE ITEMS         //
        // ****************************************** //


        var columntraits = ["Gender","degree"];
            rowtraits = ["betweeness","Height"];
            scales = {};

        var width = document.getElementById("panel").offsetWidth
            height = width
            padding = width/0.7*0.05;
            panels = Math.max(columntraits.length, rowtraits.length)
            size = (width-padding)/panels

        for (var i in columntraits) {
            trait = columntraits[i]+'_axis';
            max = d3.max(nodes, function(d) {
                return d[trait]});
            min = d3.min(nodes, function(d) {
                return d[trait]});
            scales[trait] = [min,max];
            }

        for (var i in rowtraits) {
            trait = rowtraits[i]+'_pos';
            max = d3.max(nodes, function(d) {
                return d[trait]});
            min = d3.min(nodes, function(d) {
                return d[trait]});
            scales[trait] = [min,max];
            }

        function cross(a, b){
            var c = [], n = a.length, m = b.length, i, j;
            for (i = -1; ++i < n;) for (j = -1; ++j < m;) c.push({x: a[i]+'_axis', i: i, y: b[j] + '_pos', j: j});
            return c;

        };


          // ****************************************** //
         //          MAKING THE SVG AND HIVES          //
        // ****************************************** //



        var svg = d3.select("body").select("#container").select("#panel").append("svg")
            .attr("class", SVGTitle)
            .attr("width", width)
            .attr("height", width)
            .style("background-color", bkgcolor)
          .append("g")
            .attr("transform", "translate(" + (size/2 + padding) + "," + (size/2 + padding) + ")"); //(0,0) coordinates correspond to the center of the first hive.

        var cell = svg.selectAll(".cell")
          .data(cross(columntraits,rowtraits))
        .enter().append("g")
          .attr("class", "cell")
          .attr("transform", function(d) { return "translate(" + (d.i) * size + "," + d.j * size + ")"; })
          .each(plot);
          
        function plot(p){
            var cell = d3.select(this);

            var innerRadius = size*0.05
            var outerRadius = size*0.45
            var radius = d3.scale.linear().range([innerRadius, outerRadius]);

            if (p.i == 0){
            cell.append("text")
                .attr("x", function(d) { return d.i; })
                .attr("y", function(d) { return d.j-size/2 - padding/2})
                .attr("text-anchor", "middle")
                .text(capitalize(p.y.split('_')[0]))
                .attr("transform", function(d) { 
                    return "rotate(-90)"; //"translate("+ d.i-size/2 + "," + d.j-size/2+")
                    })
                .attr("font-size", "13pt");
            }

            if (p.j==0){
            cell.append("text")
                .attr("x", function(d) { return d.i; })
                .attr("y", function(d) { return d.j-size/2 - padding/2; })
                .attr("text-anchor", "middle")
                .text(capitalize(p.x.split('_')[0]))
                .attr("font-size", "13pt");
            }

            var posScale = d3.scale.linear()
                            .domain(scales[p.y])
                            .range([0, 1]);
            var asgScale = d3.scale.quantile()
                            .domain(scales[p.x])
                            .range(d3.range(num_axis));

            // Uncomment to see the cutoffs of the scale
            //console.log(asgScale.invertExtent(0), asgScale.invertExtent(1), asgScale.invertExtent(2)) 

            cell.selectAll(".axis")
                .data(angle)
              .enter().append("line")
                .attr("class", "axis")
                .attr("transform", function(d) { return "rotate(" + degrees(angles(d)) + ")"; })
                .attr("x1", radius.range()[0])
                .attr("x2", radius.range()[1])
                .attr("stroke-width",0.7)
                .attr("stroke", "black");

            cell.selectAll(".link")
                .data(links)
              .enter().append("path")
                .attr("class", "link")
                .attr("d", d3.hive.link()
                .angle(function(d) { return angles(asgScale(d[p.x])); })
                .radius(function(d) { return radius(posScale(d[p.y])); }))
                .attr("show", function (d) {
                    if (d.source[p.x] == d.target[p.x]) {return false}
                    else {return true}
                })
                .style("fill", linkfill)
                .style("stroke-opacity", oplink)
                .style("stroke", function(d) {
                    if (edgeColor.length == 1){
                        return edgeColor}
                    else {return link_color(d.type)}
                    })
                .style("stroke-width", linkwidth)
                .on("mouseover", function(d){
                        revealLink(d, d3.select(this).style("stroke"));
                        d3.select(this).call(highlight_links)
                    })
                .on("mouseout", function(d){
                        removeReveal();
                        d3.select(this)
                            .transition()
                            .duration(800)
                            .style("stroke-opacity", oplink)
                            .style("stroke-width", linkwidth)
                    });
            
            //removes any edges between nodes on same axis.
            cell.selectAll("path[show="+false+"]").remove()

            cell.selectAll(".node")
                .data(nodes)
              .enter().append("circle")
                .attr("class", "node")
                .attr("transform", function(d) { return "rotate(" + degrees(angles(asgScale(d[p.x]))) + ")"; })
                .attr("cx", function(d) {
                        return radius(posScale(d[p.y]));})
                .attr("r", nodesize)
                .attr("stroke-width", nodestroke)
                .attr("stroke", nodestrokecolor)
                .style("fill-opacity", opnode)
                .style("fill", nodeColor)
                .on("mouseover", function(d){
                    d3.select(this)
                        .call(node_mouseover,d)
                    })
                .on("mouseout", function(d){
                    d3.select(this).call(node_mouseout)
                    })
                .attr()
        };


          // ****************************************** //
         //         SOME DISPLAY FUNCTIONS             //
        // ****************************************** //

        var node_mouseover = function(node,d) {
            node
                .call(highlight_nodes)
                revealNode(d, node.style("fill"));
            d3.selectAll(".node")
                .transition()
                .duration(hoverOverTime*0.2)
                .each(function(n){
                    if (n.name == d.name){
                        d3.select(this).call(highlight_nodes)
                    }
                })
            d3.selectAll(".link")
                .transition()
                .delay(hoverOverTime*0.1)
                .duration(hoverOverTime*0.2)
                .each(function(l){
                    if (l.source.name == d.name || l.target.name == d.name){
                        d3.select(this).call(highlight_links)
                    }
                })
        }

        var node_mouseout = function(node) {
            removeReveal();
            node
                .transition()
                .duration(hoverOverTime)
                .style("fill-opacity", opnode)
                .attr("stroke-width", nodestroke)
                .attr("stroke", nodestrokecolor)
                .attr("r", nodesize);
            d3.selectAll(".link")
                .transition()
                .duration(hoverOverTime)
                .style("stroke-opacity", oplink)
                .style("stroke-width", linkwidth)
            d3.selectAll(".node")
                .transition()
                .duration(hoverOverTime)
                .attr("r", nodesize)
                .attr("stroke-width", nodestroke)
                .attr("stroke", nodestrokecolor)
                .style("fill-opacity", opnode)
            }

        var highlight_nodes = function(selection, temporary) {
            selection
                .transition()
                .duration(function (d) {
                    if (temporary) {return hoverOverTime*1} 
                    else {return 0}
                    })
                .style("fill-opacity", 1)
                .style("stroke-width", nodestroke*3)
                .attr("stroke", 'black')
                .attr("r", nodesize*1.5)
            };

        var highlight_links = function(selection) {
            selection
                .style("stroke-opacity", 1)
                .style("stroke-width", linkwidth*2)
            };

        var revealNode = function(d,color){
            d3.select("body").select("#reveal").append("p")
                .html("<br><br><b>Name: " + d.name +"</b>"+','+"    Gender: " + d.Gender+','+"    Height: " + d.Height)
                .style("color", color)
            };

        var revealLink = function(d,color){
            d3.select("body").select("#reveal").append("p")
                .html("<br><br><b>Source: " + d.source.name + ", Target: " + d.target.name +"</b>"+','+"    Friendshipstrength: " + d.friendshipstrength+','+"    Relationship: " + d.relationship)
                .style("color", color)
            };

        var removeReveal = function(){
            d3.select("body").select("#reveal").selectAll("p")
                .remove();
            };

        function color_nodes(property, value, color, equality) {
            if (equality == '>'){
                d3.selectAll("circle").each(function(d){
                    if (d[property] > value) {
                        console.log(d)
                        d3.select(this)
                            .style("fill", color)
                   }
                })
            }            
            else if (equality == '<'){
                d3.selectAll("circle").each(function(d){
                    if (d[property] < value) {
                        d3.select(this)
                            .style("fill", color)
                   }
                })
            }
            else {
                d3.selectAll("circle").each(function(d){
                    if (d[property] == value) {
                        d3.select(this)
                            .style("fill", color)
                   }
                })
            }
        };

        function color_links(property, value, color) {
            d3.selectAll("path").each(function(d){
                if (d[property] == value) {
                    d3.select(this)
                        .style("stroke", color)
               }
            })
        };

        color_nodes('Gender', 'girl', '#FFAE00')
        color_nodes('Gender', 'alien', '#7700D9')
        color_nodes('Gender', 'boy', '#62D900')
        color_links('relationship', 'friends', 'grey')
        color_links('relationship', 'enemies', 'grey')


          // ****************************************** //
         //              SEARCH FUNCTIONS              //
        // ****************************************** //


        function show_node() {
            var node = document.getElementById("lostNode").value
            var revealed = false
            d3.selectAll("circle").each(function(d) {
                if (d['name'] == node) {
                    d3.select(this).call(highlight_nodes,true)
                    if (!revealed){
                        revealNode(d, d3.select(this).style("fill"))
                        revealed = true

                        d3.select(this)
                            .transition()
                            .delay(1000000000)
                            .call(removeReveal)
                        }
                    }
                })
            };

        d3.select("body").select("#search")
            .append("p").html('<center><form><input type="text" id="lostNode"/><input value ="Search" onclick="show_node();" type = "button"/><br></form></center>')
            .style("color", colorNeutral)



          // ****************************************** //
         //         CONTROL PANEL FUNCTIONS            //
        // ****************************************** //

        function remove_options(selector) {
            //first remove all the previous options:
            if (selector.length > 0){
                for (var i = selector.length - 1; i >= 0; i--) {
                    selector.remove(i);
                }
            }
            return selector
        };

        var property_coloring = document.getElementById("node_property")
        for (var key in nodes[0]) {
                    option = document.createElement("option")
                    option.text = key
                    property_coloring.add(option)
                };

        function make_value_options() {
            property = document.getElementById("node_property").value

            //first remove all the previous options:
            if (node_value.length > 0){
                for (var i = node_value.length - 1; i >= 0; i--) {
                    node_value.remove(i);
                };
            };

            node_value = remove_options(node_value)

            //add new options
            var options = []
            for (var i = nodes.length - 1; i >= 0; i--) {
                value = nodes[i][property]
                if (options.indexOf(value)>=0){}
                else{
                    options.push(value)
                    option = document.createElement("option")
                    option.text = value
                    node_value.add(option)
                }
            };

            if (check_quantitative(options)) {
                equality = document.getElementById("equality")
                greater = document.createElement("option")
                greater.text = '>'
                less = document.createElement("option")
                less.text = '<'
                equality.add(greater)
                equality.add(less)

            } else {
                equality = document.getElementById("equality")
                equality = remove_options(equality)
                equal = document.createElement("option")
                equal.text = '='
                equality.add(equal)
            }

        }



        function make_coloring_nodes() {
            property = document.getElementById("node_property").value
            value = document.getElementById("node_value").value
            color = document.getElementById("node_colour").value
            equality = document.getElementById("equality").value
            color_nodes(property, value, color, equality)
        }


          // ****************************************** //
         //              RANDOM FUNCTIONS              //
        // ****************************************** //

        function check_quantitative(options){
            for (o in options) {
                opt = options[o]
                if (isNaN(opt)) {
                    return false
                }
            };
            return true
        }

        function degrees(radians) {
          return radians / Math.PI * 180 - 90;
        }

        function capitalize(string)
        {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        </script>
    </body>
</html>
